# stable diffusion 动漫标签自动化评测

大家在用stable diffusion的时候，有没有遇到过你用的模型总是不能理解你要的标签的情况？

前几天我就想试试XL模型是不是能解决这类问题。按理说模型更大了，应该更聪明1点。可是下了几个动漫的XL模型，手动测试了1下，好像不仅没有解决不理解标签的问题，还更坏了？

不过感觉毕竟是不准的，1个1个用眼睛看也看不完，不如我来发明1个测试工具，直接把各种模型×各种标签统统测试1遍，这样就知道它们到底准不准了！


## 单标签测试

第1项测试比较简单，我们来测试1下模型是否能正确地画出各种类的标签。横座标是模型的名字，纵座标是标签分类，表格的数值是准确率。

- 准确率的意思是，假如我用`AOM3A1`模型，生成了`n`张包含`人物-动作`tag的图片，即每张的prompt中包含1个随机的`人物-动作`tag，然后用ML-Danbooru检测这`n`张图片，能被预测出和prompt中相同的tag的张数为`k`，那么`AOM3A1`×`人物-动作`的准确率就是`k/n`。

- 采样方法是选择使用率最高的前1500个标签，然后用每个模型给每个标签生成16张图，再把标签分到对应的分类里。因此标签的样本数是均匀的，但是分类的样本数不是均匀的。

- 模型没有挑过，我这里恰好有这几个模型，就用它们测了。如果你有什么想试的模型也可以告诉我，我1起加进来。

- 以及还有1个详细的表格，是以标签为纵座标的，在[这里](./好.md)，因为它太大了所以就不贴上来了。

<sub>

|                          | A4.5   | AOM3A1    | AOM3A2   | BP10      | CF2.2   | CF3.0     | CM20   | novelai   | BPXL0.3.1  | CFXL1.0   |
|:-------------------------|:-------|:----------|:---------|:----------|:--------|:----------|:-------|:----------|:------------|:----------|
| 艺术破格                 | 0.115  | 0.111     | 0.082    | 0.24      | 0.115   | 0.231     | 0.168  | **0.26**  | 0.163       | 0.178     |
| 人物-动作                | 0.509  | 0.534     | 0.459    | **0.604** | 0.529   | 0.584     | 0.495  | 0.502     | 0.452       | 0.437     |
| 人物-全身装饰            | 0.562  | 0.727     | 0.617    | 0.773     | 0.781   | 0.75      | 0.773  | 0.617     | 0.688       | **0.836** |
| 人物-胸部                | 0.488  | **0.557** | 0.499    | 0.518     | 0.499   | 0.517     | 0.404  | 0.499     | 0.313       | 0.337     |
| 人物-衣装                | 0.791  | 0.809     | 0.752    | **0.833** | 0.8     | 0.83      | 0.762  | 0.775     | 0.773       | 0.76      |
| 人物-摆位                | 0.456  | 0.56      | 0.44     | 0.677     | 0.596   | **0.688** | 0.565  | 0.625     | 0.599       | 0.646     |
| 人物-耳朵                | 0.815  | 0.839     | 0.81     | 0.839     | 0.848   | **0.878** | 0.777  | 0.833     | 0.821       | 0.753     |
| 人物-面部                | 0.485  | 0.521     | 0.423    | 0.633     | 0.512   | **0.647** | 0.386  | 0.57      | 0.344       | 0.403     |
| 人物-头发                | 0.594  | 0.629     | 0.57     | **0.728** | 0.64    | 0.726     | 0.608  | 0.683     | 0.585       | 0.589     |
| 人物-头部饰品            | 0.713  | 0.721     | 0.643    | 0.831     | 0.718   | **0.832** | 0.674  | 0.711     | 0.611       | 0.628     |
| 人物-类型                | 0.628  | 0.662     | 0.547    | **0.741** | 0.688   | 0.715     | 0.644  | 0.668     | 0.673       | 0.649     |
| 人物-下身装饰            | 0.731  | 0.759     | 0.721    | 0.773     | 0.76    | **0.794** | 0.662  | 0.708     | 0.607       | 0.638     |
| 人物-脖子                | 0.789  | 0.801     | 0.747    | 0.834     | 0.782   | **0.836** | 0.769  | 0.801     | 0.684       | 0.715     |
| 人物-鞋袜                | 0.704  | 0.724     | 0.686    | 0.783     | 0.768   | **0.793** | 0.704  | 0.709     | 0.667       | 0.645     |
| 人物-上身装饰            | 0.755  | 0.777     | 0.725    | **0.828** | 0.755   | 0.827     | 0.757  | 0.74      | 0.706       | 0.705     |
| 人文景观-位置-建筑物     | 0.881  | 0.903     | 0.716    | **0.96**  | 0.858   | 0.886     | 0.938  | 0.898     | 0.943       | 0.869     |
| 人文景观-食物-谷制品     | 0.65   | 0.662     | 0.625    | 0.812     | 0.738   | 0.8       | 0.75   | 0.6       | **1.0**     | 0.95      |
| 人文景观-食物-饮料       | 0.844  | 0.805     | **0.93** | 0.891     | 0.859   | 0.805     | 0.836  | 0.648     | 0.914       | 0.922     |
| 人文景观-食物-水果       | 0.757  | 0.882     | 0.847    | 0.861     | 0.889   | 0.889     | 0.806  | 0.861     | **0.993**   | **0.993** |
| 人文景观-食物-主食       | 0.675  | 0.725     | 0.662    | 0.825     | 0.762   | 0.8       | 0.775  | 0.7       | **0.838**   | 0.825     |
| 人文景观-食物-肉类   | 0.781  | 0.859     | 0.594    | 0.891     | 0.734   | 0.969     | 0.812  | 0.812     | **1.0**     | 0.984     |
| 人文景观-食物-零食   | 0.688  | 0.731     | 0.716    | **0.875** | 0.769   | 0.844     | 0.703  | 0.694     | **0.875**   | 0.831     |
| 人文景观-食物-蔬菜   | 0.792  | 0.917     | 0.823    | **0.969** | 0.948   | 0.938     | 0.927  | 0.958     | 0.875       | 0.885     |
| 人文景观-位置-室内       | 0.973  | 0.991     | 0.875    | **1.0**   | 0.982   | 0.92      | 0.964  | 0.946     | **1.0**     | **1.0**   |
| 人文景观-位置-室外       | 0.979  | 0.958     | 0.896    | **1.0**   | 0.958   | 0.99      | 0.99   | 0.969     | **1.0**     | **1.0**   |
| 构图-背景                | 0.779  | 0.793     | 0.673    | **0.933** | 0.798   | 0.899     | 0.827  | 0.812     | 0.856       | 0.822     |
| 构图-打码方式            | 0.131  | **0.438** | 0.381    | 0.231     | 0.331   | 0.269     | 0.163  | 0.237     | 0.006       | 0.031     |
| 构图-色彩                | 0.281  | 0.317     | 0.098    | **0.772** | 0.353   | 0.75      | 0.415  | 0.607     | 0.612       | 0.763     |
| 构图-构图方式            | 0.237  | 0.344     | 0.156    | **0.469** | 0.306   | 0.412     | 0.237  | 0.3       | 0.125       | 0.138     |
| 构图-制图特效            | 0.484  | 0.496     | 0.254    | 0.758     | 0.539   | **0.809** | 0.598  | 0.672     | 0.551       | 0.531     |
| 构图-图片类型            | 0.36   | 0.441     | 0.342    | **0.57**  | 0.518   | 0.518     | 0.507  | 0.555     | 0.173       | 0.199     |
| 构图-视角                | 0.633  | 0.671     | 0.454    | 0.808     | 0.738   | **0.812** | 0.65   | 0.762     | 0.7         | 0.675     |
| 构图-画风                | 0.136  | 0.267     | 0.074    | 0.369     | 0.131   | **0.409** | 0.307  | **0.409** | 0.335       | 0.312     |
| 物品                     | 0.791  | 0.847     | 0.797    | **0.934** | 0.812   | **0.934** | 0.828  | 0.847     | 0.844       | 0.819     |
| 自然景观-花卉            | 0.832  | 0.852     | 0.838    | **0.989** | 0.818   | 0.943     | 0.906  | 0.767     | 0.974       | 0.966     |
| 自然景观-位置-室外       | 0.901  | 0.922     | 0.875    | **1.0**   | 0.911   | 0.995     | 0.974  | 0.953     | **1.0**     | **1.0**   |
| 自然景观-天空/气象       | 0.854  | 0.88      | 0.734    | 0.979     | 0.859   | 0.87      | 0.891  | 0.823     | **1.0**     | 0.938     |
| 限制级-成年限定          | 0.295  | **0.599** | 0.454    | 0.444     | 0.44    | 0.433     | 0.363  | 0.352     | 0.087       | 0.114     |
| 限制级-限制级            | 0.502  | **0.693** | 0.54     | 0.615     | 0.605   | 0.675     | 0.573  | 0.557     | 0.325       | 0.417     |

</sub>

> 表格长度不够，缩写了1下。A指anything，Bp指blue_pencil，CF指Counterfeit，CM指cosplaymix。
> 
> 加粗表示它是当前标签的top1。

可以看出: 

- 表现比较优秀的模型是blue_pencil_v10和Counterfeit-3.0。

- XL模型普遍不如原版模型准，只在1些无关紧要的方面有优势。

## 多标签测试-准确度

接下来是测试模型在单张图片的标签数变多时，是会顾此失彼，还是能把这些标签都画出来。同上，横座标是模型的名字，纵座标是标签分类，表格的数值是准确率。

- 准确率的意思是，假如我用`AOM3A1`模型，生成了`n`张包含`m`个tag的图片，即每张的prompt中包含`m`个随机的tag，然后用ML-Danbooru检测这`n`张图片，每张图片中能被预测出和prompt中相同的tag的数量总和为`k`，那么`AOM3A1`×`n tags`的准确率就是`k/(n*m)`。

- 采样方法是每次从使用率最高的前1500个tag中随机抽取`m`个，然后用每个模型给这1次的`m`个tag生成16张图。


<sub>

|     |   A4.5 |   AOM3A1 |   AOM3A2 | BP10      |   CF2.2 | CF3.0     |   CM20 |   novelai |   BPXL0.3.1 |   CFXL1.0 |
|----:|-------:|---------:|---------:|:----------|--------:|:----------|-------:|----------:|------------:|----------:|
|   2 |  0.721 |    0.754 |    0.692 | 0.8       |   0.746 | **0.815** |  0.694 |     0.706 |       0.681 |     0.669 |
|   4 |  0.635 |    0.683 |    0.624 | **0.702** |   0.668 | 0.66      |  0.603 |     0.623 |       0.547 |     0.535 |
|   8 |  0.548 |    0.568 |    0.585 | **0.63**  |   0.594 | 0.608     |  0.491 |     0.511 |       0.437 |     0.41  |
|  16 |  0.457 |    0.482 |    0.478 | **0.527** |   0.499 | 0.524     |  0.427 |     0.42  |       0.359 |     0.334 |
|  32 |  0.353 |    0.386 |    0.383 | **0.425** |   0.388 | 0.413     |  0.32  |     0.326 |       0.267 |     0.246 |
|  64 |  0.278 |    0.321 |    0.305 | **0.332** |   0.314 | 0.322     |  0.254 |     0.262 |       0.194 |     0.17  |
| 128 |  0.245 |    0.27  |    0.263 | **0.279** |   0.266 | 0.271     |  0.213 |     0.236 |       0.167 |     0.142 |

</sub>

看来多标签的标准下，表现最优秀的还是blue_pencil_v10。

## 多标签测试-多样性

接下来来测试模型生成图片的多样性。横座标是模型的名字，纵座标是标签分类，表格的数值是多样性。

- 多样性的意思是，假如我用`AOM3A1`模型，在相同tag下生成了`n`张图片，将每1张图和它的后1张图过CLIP之后计算embedding的余弦相似度，`1-这些余弦相似度的平均值`即为`AOM3A1`×`n tags`的多样性。

<sub>

|     |   A4.5 |   AOM3A1 |   AOM3A2 |   BP10 |   CF2.2 |   CF3.0 |   CM20 | novelai   |   BPXL0.3.1 |   CFXL1.0 |
|----:|-------:|---------:|---------:|-------:|--------:|--------:|-------:|:----------|------------:|----------:|
|   2 |  0.15  |    0.17  |    0.154 |  0.153 |   0.188 |   0.152 |  0.186 | **0.197** |       0.125 |     0.115 |
|   4 |  0.147 |    0.156 |    0.15  |  0.146 |   0.174 |   0.147 |  0.165 | **0.203** |       0.112 |     0.12  |
|   8 |  0.126 |    0.136 |    0.132 |  0.121 |   0.155 |   0.127 |  0.154 | **0.177** |       0.109 |     0.117 |
|  16 |  0.131 |    0.133 |    0.132 |  0.118 |   0.155 |   0.132 |  0.154 | **0.182** |       0.099 |     0.101 |
|  32 |  0.13  |    0.129 |    0.127 |  0.121 |   0.147 |   0.131 |  0.15  | **0.189** |       0.103 |     0.108 |
|  64 |  0.117 |    0.123 |    0.129 |  0.124 |   0.137 |   0.144 |  0.147 | **0.183** |       0.103 |     0.107 |
| 128 |  0.115 |    0.13  |    0.134 |  0.127 |   0.145 |   0.14  |  0.15  | **0.191** |       0.102 |     0.107 |

</sub>

最多样的是novelai，这个模型确实多样化程度很高。


## 使用方法

- 首先你要有1个[stable-diffusion-webui](https://github.com/AUTOMATIC1111/stable-diffusion-webui)。运行`webui-user.bat`，启动参数需要加上`--api`。

- 安装依赖: `pip install -r requirements.txt`。

- 运行评测代码: `python 评测单标签.py`或`python 评测多标签.py`。会生成`记录.json`或`记录_多标签.json`文件，包含1个巨大的list。

- 导出表格: `python 导出表格.py`。会读取记录文件，生成`1.md`文件，里面就是以表格形式打出的指标了。


## 结束

顺便说1下，标签目录是从<https://github.com/wfjsw/danbooru-diffusion-prompt-builder>扣出来的，但是因为我是傲娇所以不会感谢她！

就这样，大家88，我要回去和GPT亲热了！
