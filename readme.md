# stable diffusion 动漫标签自动化评测

大家在用stable diffusion的时候，有没有遇到过你用的模型总是不能理解你要的标签的情况？

前几天我就想试试XL模型是不是能解决这类问题。按理说模型更大了，应该更聪明1点。可是下了几个动漫的XL模型，手动测试了1下，好像不仅没有解决不理解标签的问题，还更坏了？

不过感觉毕竟是不准的，1个1个用眼睛看也看不完，不如我来发明1个测试工具，直接把各种模型×各种标签统统测试1遍，这样就知道它们到底准不准了！


## 结果

横座标是模型的名字，纵座标是标签分类，表格的数值是准确率。

- 准确率的意思是，假如我用`AOM3A1`模型，生成了`n`张包含`人物-动作`tag的图片，即每张的prompt中包含1个随机的`人物-动作`tag，然后用ML-Danbooru检测这`n`张图片，能被预测出和prompt中相同的tag的张数为`k`，那么`AOM3A1`×`人物-动作`的准确率就是`k/n`。

- 因为我只有1张显卡，1天测不了多少，所以随机采样了1些。方法是随机抽取使用率最高的前1500个标签中的341个标签，然后用每个模型给每个标签生成16张图，再把标签分到对应的分类里。因此标签的样本数是均匀的，但是分类的样本数不是均匀的。

- 模型没有挑过，我这里恰好有这几个模型，就用它们测了。如果你有什么想试的模型也可以告诉我，我1起加进来。

- 以及还有1个详细的表格，是以标签为纵座标的，在[这里](./好.md)，因为它太大了所以就不贴上来了。

<sub>

|                          | AOM3A1    | AOM3A2    | Counterfeit-V2.2   | CounterfeitXL-V1.0   | anything-v4.5   | blue_pencil-XL-v0.3.1   | cosplaymix_v20  | novelai  |
|:-------------------------|:----------|:----------|:-------------------|:---------------------|:----------------------------|:------------------------|:-----------------|:-----------------------|
| 艺术破格                 | 0.05      | 0.113     | 0.037              | **0.275**            | 0.1                         | 0.2                     | 0.175            | 0.263                  |
| 人物-动作                | 0.587     | 0.533     | **0.59**           | 0.439                | 0.571                       | 0.465                   | 0.517            | 0.517                  |
| 人物-全身装饰            | 0.656     | 0.594     | 0.406              | **0.75**             | 0.375                       | 0.375                   | 0.25             | 0.406                  |
| 人物-胸部                | **0.512** | 0.441     | 0.434              | 0.278                | 0.441                       | 0.263                   | 0.312            | 0.459                  |
| 人物-衣装                | **0.944** | 0.891     | 0.935              | 0.859                | 0.931                       | 0.905                   | 0.894            | 0.919                  |
| 人物-摆位                | 0.598     | 0.482     | 0.705              | 0.625                | 0.509                       | 0.562                   | 0.589            | **0.741**              |
| 人物-耳朵                | 0.964     | 0.902     | **0.973**          | 0.893                | 0.938                       | 0.938                   | 0.83             | 0.929                  |
| 人物-面部                | 0.596     | 0.511     | 0.575              | 0.474                | 0.546                       | 0.428                   | 0.465            | **0.608**              |
| 人物-头发                | 0.771     | 0.723     | 0.783              | 0.732                | 0.744                       | 0.747                   | 0.693            | **0.801**              |
| 人物-头部饰品            | 0.846     | 0.776     | 0.857              | 0.737                | **0.859**                   | 0.755                   | 0.802            | 0.831                  |
| 人物-类型                | 0.742     | 0.672     | 0.77               | 0.727                | 0.68                        | **0.789**               | 0.676            | 0.738                  |
| 人物-下身装饰            | **0.812** | 0.786     | **0.812**          | 0.691                | 0.803                       | 0.648                   | 0.714            | 0.773                  |
| 人物-脖子                | **0.893** | 0.786     | 0.875              | 0.875                | 0.875                       | 0.848                   | 0.875            | 0.884                  |
| 人物-鞋袜                | 0.849     | 0.781     | **0.885**          | 0.724                | 0.807                       | 0.833                   | 0.87             | 0.844                  |
| 人物-上身装饰            | **0.91**  | 0.902     | **0.91**           | 0.772                | 0.9                         | 0.795                   | 0.868            | 0.868                  |
| 人文景观-食物-水果       | 0.812     | 0.781     | 0.719              | **0.969**            | 0.594                       | **0.969**               | 0.562            | 0.719                  |
| 人文景观-食物-糖果零食   | 0.969     | 0.812     | 0.906              | 0.969                | 0.906                       | **1.0**                 | 0.875            | 0.781                  |
| 人文景观-食物-蔬菜与香料 | **1.0**   | **1.0**   | **1.0**            | **1.0**              | **1.0**                     | **1.0**                 | **1.0**          | **1.0**                |
| 人文景观-位置-室外       | 0.969     | 0.812     | 0.938              | **1.0**              | 0.969                       | **1.0**                 | **1.0**          | 0.938                  |
| 构图-背景                | **1.0**   | **1.0**   | **1.0**            | **1.0**              | **1.0**                     | **1.0**                 | **1.0**          | **1.0**                |
| 构图-打码方式            | 0.5       | **0.531** | **0.531**          | 0.031                | 0.438                       | 0.0                     | 0.469            | 0.5                    |
| 构图-色彩                | 0.312     | 0.094     | 0.625              | 0.281                | 0.312                       | 0.344                   | 0.375            | **0.75**               |
| 构图-制图特效            | 0.696     | 0.223     | 0.679              | 0.598                | 0.634                       | 0.625                   | 0.777            | **0.884**              |
| 构图-图片类型            | 0.406     | 0.281     | 0.594              | 0.188                | 0.354                       | 0.167                   | 0.542            | **0.656**              |
| 构图-视角                | 0.719     | 0.453     | **0.828**          | 0.734                | 0.594                       | 0.812                   | 0.656            | 0.797                  |
| 物品                     | **0.891** | 0.867     | 0.875              | 0.859                | 0.867                       | 0.867                   | **0.891**        | 0.883                  |
| 自然景观-花卉            | 0.859     | 0.812     | 0.891              | **1.0**              | 0.859                       | 0.984                   | 0.906            | 0.859                  |
| 自然景观-位置-室外       | **1.0**   | 0.906     | 0.906              | **1.0**              | 0.906                       | **1.0**                 | **1.0**          | **1.0**                |
| 自然景观-天空/气象       | 0.938     | 0.656     | 0.875              | **1.0**              | 0.891                       | **1.0**                 | 0.906            | 0.906                  |
| 限制级-成年限定          | **0.612** | 0.482     | 0.496              | 0.188                | 0.295                       | 0.125                   | 0.442            | 0.371                  |
| 限制级-限制级            | **0.806** | 0.639     | 0.722              | 0.542                | 0.618                       | 0.479                   | 0.701            | 0.708                  |

</sub>

可以看出: 

- 画人物比较准的模型是AOM3A1和Counterfeit-V2.2。

- 构图比较准的是novelai。

- XL模型普遍不如原版模型准，只在1些无关紧要的方面有优势。


## 使用方法

- 首先你要有1个[stable-diffusion-webui](https://github.com/AUTOMATIC1111/stable-diffusion-webui)。运行`webui-user.bat`，启动参数需要加上`--api`。

- 安装依赖: `pip install -r requirements.txt`。

- 运行评测代码: `python 评测.py`。会生成`记录.json`文件，包含1个巨大的list。

- 导出表格: `python 导出表格.py`。会读取`记录.json`文件，生成`1.md`文件。


## 结束

顺便说一下，标签目录是从<https://github.com/wfjsw/danbooru-diffusion-prompt-builder>扣出来的，但是因为我是傲娇所以不会感谢她！

就这样，大家88，我要回去和GPT亲热了！
