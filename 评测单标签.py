import json
import base64
import itertools
from pathlib import Path

from tqdm import tqdm

from common import 缓存上网, ml_danbooru标签, safe_name, 服务器地址, check_model


要测的模型 = [
    ('anything-v4.5-pruned-fp32', 'anything-v4.0.vae.pt'),
    ('AOM3A1', 'orangemix.vae.pt'),
    ('AOM3A2', 'orangemix.vae.pt'),
    ('cosplaymix_v20', None),
    ('Counterfeit-V2.2', 'Counterfeit-V2.5.vae.pt'),
    ('Counterfeit-V2.5_pruned', 'Counterfeit-V2.5.vae.pt'),
    ('novelailatest-pruned', 'novelailatest-pruned.vae.pt'),
    ('CounterfeitXL-V1.0', None),
    ('blue_pencil-XL-v0.3.1', None),
    ('bluePencil_v10', 'clearvae_v23.safetensors'),
    ('Counterfeit-V3.0_fp16', 'kl-f8-anime2.ckpt'),
    ('AnythingV5Ink_ink', None),
    ('sweetfruit_melon.safetensors_v1.0', 'vae-ft-mse-840000-ema-pruned.ckpt'),
    ('cuteyukimixAdorable_midchapter3', 'anything-v4.0.vae.pt'),
    ('perfectWorld_v2Baked', None),
    ('perfectWorld_v6Baked', None),
    ('meinamix_meinaV11', None),
    ('cetusMix_Whalefall2', 'kl-f8-anime2.ckpt'),
]
要测的标签 = ['1girl', 'solo', 'highres', 'long hair', 'breasts', 'looking at viewer', 'blush', 'smile', 'short hair', 'open mouth', 'bangs', 'blue eyes', 'skirt', 'blonde hair', 'large breasts', 'brown hair', 'simple background', 'black hair', 'hair ornament', 'absurdres', 'red eyes', 'thighhighs', 'gloves', '1boy', 'long sleeves', 'white background', 'dress', 'original', 'ribbon', 'bow', 'navel', '2girls', 'holding', 'animal ears', 'cleavage', 'hair between eyes', 'bare shoulders', 'twintails', 'brown eyes', 'medium breasts', 'jewelry', 'sitting', 'very long hair', 'underwear', 'closed mouth', 'nipples', 'school uniform', 'green eyes', 'blue hair', 'standing', 'purple eyes', 'collarbone', 'panties', 'tail', 'monochrome', 'swimsuit', 'full body', 'closed eyes', 'hair ribbon', 'yellow eyes', 'ponytail', 'upper body', 'purple hair', 'pink hair', 'ass', 'braid', 'comic', 'flower', 'ahoge', ':d', 'hair bow', 'greyscale', 'white hair', 'pantyhose', 'bikini', 'sidelocks', 'thighs', 'nude', 'red hair', 'cowboy shot', 'grey hair', 'pleated skirt', 'multicolored hair', 'hairband', 'earrings', 'small breasts', 'boots', 'outdoors', 'lying', 'censored', 'frills', 'parted lips', 'detached sleeves', 'one eye closed', 'japanese clothes', 'green hair', 'wings', 'open clothes', 'necktie', 'sky', 'horns', 'penis', 'glasses', 'shorts', 'barefoot', 'teeth', 'pussy', 'serafuku', 'solo focus', 'day', 'alternate costume', 'choker', 'tongue', 'pointy ears', 'socks', 'elbow gloves', 'hairclip', 'fang', 'midriff', 'striped', 'belt', 'looking back', 'collared shirt', 'sword', 'official art', 'black thighhighs', 'cloud', 'indoors', 'cat ears', 'tears', 'hair flower', 'signature', 'spread legs', 'cum', '2boys', 'hood', 'sex', 'miniskirt', 'tongue out', 'on back', 'fingerless gloves', 'blunt bangs', 'bowtie', 'armpits', 'pink eyes', 'medium hair', 'sailor collar', 'kimono', 'silver hair', 'water', 'necklace', 'black legwear', 'off shoulder', 'chibi', 'hair bun', 'clothes lift', 'from behind', 'cape', 'scarf', 'bra', 'yuri', 'white dress', 'rabbit ears', 'white panties', 'mole', 'hair over one eye', 'grin', 'uniform', 'huge breasts', ':o', 'blurry', 'black eyes', 'apron', 'looking at another', 'vest', 'black dress', 'mosaic censoring', 'arm up', 'high heels', 'twin braids', 'shiny hair', 'arms up', 'flat chest', 'side ponytail', 'bracelet', 'collar', 'covered nipples', 'from side', 'aqua eyes', 'white thighhighs', 'leotard', 'two side up', 'sketch', 'lips', 'zettai ryouiki', 'coat', 'streaked hair', 'v-shaped eyebrows', 'neckerchief', 'crop top', 'head tilt', 'see-through', 'orange eyes', 'white legwear', 'gradient', 'hand on hip', 'gun', 'wrist cuffs', 'sleeves past wrists', 'looking to the side', 'torn clothes', 'maid', 'grey eyes', 'parted bangs', 'kneehighs', 'maid headdress', 'one-piece swimsuit', 'cosplay', 'petals', 'pubic hair', 'symbol-shaped pupils', 'fox ears', 'gradient background', 'loli', 'short shorts', 'ascot', 'dutch angle', 'eyelashes', 'bar censor', 'no humans', 'bare legs', 'mole under eye', 'dress shirt', 'sparkle', 'kneeling', 'lowres', 'single braid', 'bodysuit', 'v', 'no bra', 'saliva', 'bell', 'double bun', 'uncensored', 'military uniform', 'blood', 'hoodie', 'sideboob', 'scan', 'tattoo', '4koma', 'pussy juice', 'profile', 'gradient hair', 'makeup', 'neck ribbon', 'leaning forward', 'mask', 'multiple views', 'no panties', 'witch hat', 'capelet', 'anus', ':3', 'alternate hairstyle', 'detached collar', 'underboob', 'night', 'floating hair', 'depth of field', 'buttons', 'sleeveless dress', '^ ^', 'toes', 'cameltoe', 'blue dress', 'fox tail', 'feet out of frame', 'bottomless', 'nose blush', 'swept bangs', 'rose', 'fake animal ears', 'holding hands', 'facial hair', 'turtleneck', 'siblings', 'headphones', 'ocean', 'heterochromia', 'arm support', 'low twintails', 'halterneck', 'umbrella', 'frown', 'beret', 'pov', 'thigh boots', 'embarrassed', 'one side up', 'fangs', 'back', 'from above', 'watermark', 'garter straps', 'ass visible through thighs', 'wavy hair', 'upper teeth', 'on side', 'plaid skirt', 'transparent background', 'wariza', 'traditional media', 'mouth hold', 'chair', 'beach', 'parody', 'bandages', 'looking away', 'blush stickers', 'expressionless', 'drill hair', 'chinese clothes', 'grabbing', 'thick thighs', 'arms behind back', 'obi', 'halo', 'heart-shaped pupils', 'clothes pull', 'topless', 'pantyshot', 'thigh gap', 'looking down', 'short dress', 'skirt lift', 'eyepatch', 'magical girl', 'floral print', 'crossed arms', 'piercing', 'wavy mouth', 'hair intakes', 'border', 'formal', 'moon', 'leg up', 'half-closed eyes', 'from below', 'cleavage cutout', 'cover', 'happy', 'oral', 'red dress', 'squatting', 'sunglasses', 'testicles', 'school swimsuit', 'bdsm', 'trembling', 'blazer', 'wolf ears', 'standing on one leg', 'game cg', 'light brown hair', 'backpack', 'bob cut', 'eyes visible through hair', 'knee boots', 'lingerie', 'breast grab', 'demon girl', 'frilled dress', 'cardigan', 'bat wings', 'crossed legs', ';d', 'hood down', 'antenna hair', 'outstretched arms', 'crying', 'tank top', 'own hands together', 'polka dot', 'suit', 'aged down', 'undressing', 'crown', 'tiara', 'bent over', 'breasts out', 'high ponytail', 'light smile', 'horse ears', 'animated', 'looking up', 'straddling', 'black hairband', 'x hair ornament', '> <', 'wing collar', 'plant', 'on stomach', 'hair bobbles', 'outstretched arm', 'areolae', 'lipstick', 'short twintails', 'bondage', 'letterboxed', 'girl on top', 'lifted by self', 'cat girl', 'pointing', 'revision', 'slit pupils', 'all fours', 'spiked hair', '^^^', 'sisters', 'hand on own chest', 'panty pull', 'cherry blossoms', 'blouse', 'clenched teeth', 'goggles', 'brooch', 'cover page', 'bike shorts', 'casual', 'loafers', 'demon horns', 'elf', 't-shirt', 'fox girl', 'pink panties', 'building', 'motion lines', 'horse girl', 'wristband', 'messy hair', 'striped panties', 'between breasts', 'breast press', 'surprised', 'group sex', 'child', 'drooling', 'clenched hand', 'fishnets', 'hakama', 'rope', 'candy', 'genderswap', 'facial', 'side-tie panties', 'covering', 'foreshortening', 'nature', 'dog ears', 'adapted costume', 'portrait', 'anal', 'pink dress', 'demon tail', 'peaked cap', 'armband', 'waist apron', 'convenient censoring', 'night sky', 'ejaculation', 'china dress', 'arms behind head', 'alice margatroid', 'tokin hat', 'bandaid', 'microphone', 'bara', 'lace', 'mole under mouth', 'front-tie top', 'bow panties', 'strapless dress', 'hakama skirt', 'yaoi', 'glowing eyes', 'anger vein', 'no headwear', 'straight hair', 'breasts apart', 'christmas', 'hair flaps', 'hair over shoulder', 'cum on breasts', 'twin drills', 'hooded jacket', 'torn legwear', ':<', 'angry', 'facing viewer', 'cloak', 'eyewear on head', 'side braid', 'corset', 'micro bikini', 'bright pupils', 'mary janes', 'index finger raised', 'purple dress', ':p', 'tareme', 'paizuri', 'close-up', 'french braid', 'striped thighhighs', 'puffy nipples', 'furry', 'neck bell', 'full moon', 'tsurime', 'forehead', 'eye contact', 'areola slip', 'upskirt', 'striped legwear', 'seiza', 'genderswap (mtf)', 'lens flare', 'armlet', 'hand on own face', 'between legs', 'side slit', 'horse tail', 'handgun', 'pendant', 'camisole', 'skin fang', 'masturbation', 'alcohol', 'handjob', 'low ponytail', 'heavy breathing', 'cross-laced footwear', 'hair scrunchie', 'cowgirl position', 'santa hat', 'highleg leotard', 'breast hold', 'personification', 'clenched hands', 'forest', 'dress lift', 'halloween', 'cropped legs', 'wide hips', 'high heel boots', 'doujin cover', 'low-tied long hair', 'hood up', 'legs up', 'hair rings', 'backlighting', 'pencil skirt', 'jpeg artifacts', 'fish', 'clothed sex', 'sleeves past fingers', 'starry sky', 'half updo', 'spot color', 'panties under pantyhose', 'tearing up', 'asymmetrical legwear', 'kemonomimi mode', 'sailor dress', 'akemi homura', 'rain', 'garter belt', 'dual wielding', 'walking', 'cuffs', 'fingering', 'santa costume', 'crossdressing', 'dragon horns', 'legs apart', 'teacup', 'out of frame', 'black wings', 'naughty face', 'demon wings', 'thong', 'cake', 'condom', 'gym uniform', 'short ponytail', 'rape', 'denim shorts', 'curly hair', 'fur collar', 'doggystyle', ':q', 'outside border', 'lolita fashion', 'goggles on head', 'empty eyes', 'alternate breast size', 'science fiction', 'crying with eyes open', "hand on another's head", 'green dress', 'outline', 'buruma', 'jitome', 'light blush', 'futanari', 'monster', 'sunset', 'hands on hips', 'emphasis lines', 'aged up', 'asymmetrical hair', 'high-waist skirt', 'running', 'breast squeeze', 'o o', 'competition swimsuit', '= =', 'angel wings', 'tied hair', 'dog tail', 'minigirl', 'head rest', 'faceless male', '+ +', 'blue theme', 'ghost', 'bespectacled', 'paw pose', 'folded ponytail', 'sarashi', 'popsicle', 'cigarette', 'hand in pocket', 'yukata', 'hand between legs', 'hair down', 'high collar', 'twins', 'dragon girl', 'upside-down', 'serious', 'jeans', 'robe', 'smirk', 'braided ponytail', 'lollipop', ';)', 'hoop earrings', 'dakimakura (medium)', 'bouncing breasts', 'missionary', 'pajamas', '@ @', 'red rose', 'wide-eyed', 'ofuda', 'tentacle hair', 'contemporary', '| |', 'breastplate', ':t', 'blurry foreground', 'threesome', 'hairpin', 'chocolate', 'white hairband', 'jumping', 'sports bra', 'outstretched hand', 'chopsticks', 'oekaki', 'full-face blush', 'bouquet', 'star hair ornament', 'valentine', 'mountain', 'animal hood', 'covering breasts', 'cropped torso', 'wedding dress', 'city', 'video', 'miko', 'glint', 'vibrator', 'animated gif', 'enmaided', 'panties aside', 'doll', 'bloomers', 'backless outfit', 'cum on hair', 'crossed bangs', 'bandaged arm', 'fighting stance', 'hair bell', 'pout', 'multicolored eyes', 'waving', 'colored inner hair', 'raised eyebrows', 'motion blur', 'forehead mark', 'ice cream', 'mouse ears', 'realistic', 'strawberry', 'panties around one leg', 'brother and sister', 'nurse cap', 'hands in pockets', 'center opening', 'leash', 'hair tie', 'clitoris', 'anklet', 'hime cut', 'covering mouth', 'card (medium)', 'dildo', 'sailor hat', 'top-down bottom-up', 'overflow', 'scar across eye', 'sitting on person', 'alternate color', 'mouth mask', 'asymmetrical bangs', 'interracial', 'dragon tail', 'blindfold', 'frog hair ornament', 'adjusting hair', 'spread arms', 'furrowed brow', 'camera', 'licking lips', 'off-shoulder dress', 'wand', 'long dress', 'arms at sides', 'double v', 'arched back', 'zoom layer', 'tall image', 'apple', 'head out of frame', 'hanging breasts', 'sun', 'lowleg', 'sunflower', 'gag', 'labcoat', 'heart hair ornament', 'groping', 'anime screencap', 'yokozuwari', 'alternate hair length', 'bandeau', 'wince', 'gothic lolita', 'shota', 'pasties', 'leg lift', 'dog girl', "jack-o'-lantern", 'highleg panties', 'angel', 'black sclera', 'red hairband', 'partially visible vulva', 'hand on own cheek', 'hand on headwear', 'lactation', 'dot nose', 'hat flower', 'underbust', 'eyeball', 'brown legwear', 'microskirt', 'back-to-back', 'wolf girl', 'ass focus', 'ahegao', 'tabi', 'large areolae', 'food on face', 'nipple slip', 'collared dress', 'criss-cross halter', 'logo', 'pocky', 'character doll', 'gangbang', 'armored dress', 'fairy wings', 'suspender skirt', 'grabbing from behind', 'pointless censoring', 'saliva trail', 'silhouette', "hand on another's shoulder", 'silent comic', 'kneepits', 'onsen', 'crotch seam', 'leaning back', 'gohei', 'butterfly hair ornament', 'holding flower', 'retro artstyle', 'everyone', 'witch', 'no nose', 'guitar', 'center frills', 'cow ears', '2koma', 'sundress', 'pool', 'arm grab', 'heart censor', 'red lips', 'adjusting eyewear', 'bound wrists', 'bangle', 'salute', 'facing away', 'scythe', 'flipped hair', 'classroom', 'waitress', 'chromatic aberration', 'cheerleader', 'strap gap', 'absurdly long hair', 'cleft of venus', 'smug', 'pinafore dress', 'uneven legwear', 'nun', 'food-themed hair ornament', 'inverted nipples', 'hand to own mouth', 'nurse', 'potted plant', 'bikini under clothes', 'road', 'nipple tweak', 'light blue hair', 'ninja', 'sideways glance', 'eyeliner', 'foot focus', 'mecha musume', 'style parody', 'femdom', 'snake hair ornament', 'hair over eyes', 'happy sex', 'mask on head', ':>', '>:)', 'bags under eyes', 'sailor shirt', 'cityscape', 'tube top', 'naked shirt', 'bow bra', 'hair behind ear', 'crown braid', 'bad anatomy', 'brown dress', 'toeless legwear', 'fairy', 'pov hands', 'sarong', 'covering crotch', 'wet shirt', 'pleated dress', 'peach', 'hugging own legs', 'claw pose', 'print legwear', 'lolita hairband', 'bracer', 'indian style', 'alternate eye color', 'own hands clasped', 'dagger', 'painting (medium)', 'hands on own face', 'laughing', 'hair up', 'hibiscus', 'one breast out', 'wet hair', 'heart hands', 'star-shaped pupils', '3d', 'blue rose', 'lace-trimmed legwear', 'alternate hair color', 'akiyama mio', 'carrot', 'drunk', 'pumpkin', 'bodystocking', 'incest', 'marker (medium)', 'stretching', 'crescent hair ornament', 'raccoon ears', 'cone hair bun', 'office lady', 'ribbon choker', 'feather hair ornament', "hand on another's face", 'facepaint', 'red legwear', 'antlers', 'tiger ears', 'pixel art', 'magatama', 'mismatched legwear', 'lace-trimmed panties', 'slippers', 'nipple piercing', 'shibari', 'grey dress', 'wagashi', 'vampire', 'fang out', 'bald', 'bikini skirt', 'highleg bikini', 'hand on own head', 'tachi-e', 'nosebleed', 'evil smile', 'magic circle', 'layered dress', 'princess carry', 'very short hair', 'fishnet legwear', 'legwear under shorts', 'short kimono', 'layered sleeves', 'looking afar', 'hair censor', 'half gloves', 'graphite (medium)', 'scared', 'layered skirt', 'head wreath', 'reference sheet', 'tea', 'one knee', 'yellow dress', 'mother and daughter', 'w', 'open kimono', 'open hand', 'backless dress', 'mermaid', 'lace-trimmed bra', 'greaves', 'limited palette', 'bandaged leg', 'glowing eye', 'field', 'lineart', 'mmf threesome', 'symmetrical docking', 'watercolor (medium)', 'out-of-frame censoring', 'colorized', 'huge ass', 'bedroom', 'breast sucking', 'thumbs up', 'sleeveless turtleneck', 'bound arms', 'halftone', 'undercut', 'naked apron', 'peeing', 'shackles', 'double penetration', 'slingshot swimsuit', 'bra lift', 'idol', 'hair over breasts', 'ruins', 'blue hairband', 'striped dress', 'leggings', '^o^', 'mushroom', 'house', 'dark persona', 'skirt pull', 'purple legwear', 'annoyed', 'fox mask', 'ringed eyes', 'genderswap (ftm)', '3koma', 'arm under breasts', 'face-to-face', 'sad', 'bathroom', 'asymmetrical docking', 'bikini pull', 'bikini armor', 'doughnut', 'yukkuri shiteitte ne', 'babydoll', 'scar on cheek', 'cutoffs', 'hand on own knee', 'headphones around neck', 'two-tone dress', '0 0', 'fundoshi', 'bread', 'sweater dress', 'necktie between breasts', 'white rose', 'cunnilingus', 'x-ray', 'white eyes', 'wide shot', 'big hair', 'covered eyes', 'cow girl', 'constricted pupils', 'casual one-piece swimsuit', 'split', 'anchor hair ornament', 'bobby socks', 'body writing', 'leaf hair ornament', ';o', 'navel piercing', 'no pupils', 'handcuffs', 'untied bikini', 'breast rest', 'yin yang', 'pink theme', 'rolling eyes', 'cookie', 'pink rose', 'spiked collar', 'forehead jewel', 'blue neckwear', 'neck ring', 'gyaru', 'watermelon', 'partially colored', 'bridge', 'purple theme', 'rimless eyewear', 'afterimage', 'folded', 'sheet grab', 'sailor senshi uniform', 'rice', 'badge', 'sitting on lap', 'interspecies', 'lion ears', ':/', 'hooded cloak', 'beer', 'sake', 'heart earrings', 'red theme', 'rainbow', 'egg', 'pointing at viewer', 'giantess', 'd:', 'straight-on', 'mini top hat', 'tying hair', 'feeding', 'lowleg panties', 'pink thighhighs', 'bathtub', 'sepia', 'error', 'cherry', 'torogao', '3:', 'police', 'front ponytail', 'grey legwear', 'race queen', 'faulds', '\\m/', 'pinky out', 'perspective', 'sleepy', 'bear ears', 'seductive smile', 'uwabaki', 'bead bracelet', 'latex', 'hair slicked back', 'reclining', 'taut shirt', 'nervous', 'green theme', 'bead necklace', 'multi-strapped bikini', 'looping animation', 'leaning to the side', 'animalization', 'loose socks', 'blank eyes', 'pink legwear', 'huge ahoge', 'unfinished', 'coffee', 'harness', 'pointy hair', 'fat mons', 'xd', 'hair pulled back', 'blue legwear', 'black neckwear', 'bestiality', 'burger', 'poolside', 'bandaid on leg', 'bra pull', 'multicolored dress', 'nightgown', 'speed lines', 'yawning', 'twisted torso', 'wine', 'whip', 'expressions', 'skull hair ornament', 'standing split', 'braided bun', 'ear blush', 'river', 'gigantic breasts', 'street', 'split mouth', 'castle', 'grapes', 'flat color', 'between fingers', ':|', 'footjob', 'female pervert', 'female ejaculation', 'wet panties', 'police uniform', 'argyle legwear', 'animal collar', 'breast envy', 'sparkling eyes', 'forehead protector', 'checkered', 'long braid', ';p', 'hand on own stomach', 'topknot', 'hand on own ass', 'competition school swimsuit', 'v-neck', 'breast suppress', 'bursting breasts', 'facing another', 'covering face', 'dango', 'costume switch', 'exhibitionism', 'heart cutout', 'yandere', 'gym shirt', 'bokeh', 'sanpaku', 'holding eyewear', 'reaching', 'armpit peek', 'moaning', 'dougi', 'braided bangs', 'panty & stocking with garterbelt', 'fox shadow puppet', 'thong bikini', 'onigiri', 'military jacket', 'aki minoriko', 'hydrangea', 'anal beads', 'stomach bulge', 'fake screenshot', 'noodles', 'leg warmers', 'flower field', 'rose petals', 'breast lift', 'convenient leg', 'jumpsuit', 'solid circle eyes', 'turn pale', 'mind control', 'colored pencil (medium)', 'skyscraper', 'yellow hairband', 'glaring', 'leotard under clothes', 'multiple 4koma', 'heart ahoge', 'chest jewel', 'pink hairband', 'knees to chest', 'double handjob', 'elbow pads', 'kitsune', 'spring onion', 'halter dress', 'pussy peek', 'yellow sclera', 'side braids', 'hooded coat', 'no mouth', 'bra strap', 'naked ribbon', 'shushing', 'impossible shirt', "grabbing another's hair", 'heart-shaped chocolate', 'lowleg bikini', 'ringlets', '>:(', 'detached wings', 'fedora', 'akiyama yukari', 'popped collar', 'dark blue hair', 'pov crotch', 'bow hairband', 'aki shizuha', 'crazy eyes', 'holding strap', 'hands on own knees', 'maebari', 'heart pasties', 'fur-trimmed dress', 'sailor', 'cane', 'ice cream cone', 'business suit', 'tower', 'waterfall', 'unbuttoned shirt', 'bustier', 'butterfly wings', 'dark elf', 'pearl necklace', 'cropped', 'streaming tears', 'torn dress', 'bound legs', 'surgical mask', 'no pussy', 'oppai loli', 'crab', 'leg tattoo', 'kitchen', 'ribbon-trimmed legwear', 'dress pull', 'yellow theme', "hand on another's cheek", 'landscape', 'fusion', 'tsundere', 'cat cutout', 'milk', 'no legwear', 'orange dress', 'long tongue', 'checkered skirt', 'cropped shirt', 'sagging breasts', 'anal tail', 'cat lingerie', 'hatching (texture)', "hand on another's chin", 'cat hair ornament', 'muted color', 'library', '1koma', 'sideways mouth', 'virgin killer sweater', 'mask removed', 'raised eyebrow', 'sleeves pushed up', 'school', 'gradient eyes', 'shy', 'album cover', 'taking picture', 'unaligned breasts', 'mandarin orange', 'colorful', 'clover', 'command spell', 'musical note hair ornament', 'dragon wings', 'backboob', 'carrot hair ornament', 'pointing up', 'husband and wife', 'v over eye', 'half-closed eye', 'barcode', ':>=', 'the pose', 'lake', 'fisheye', 'paizuri under clothes', 'lanyard', 'purple hairband', 'pointing at self', 'dark nipples', 'american flag legwear', 'aerith gainsborough', 'no nipples', 'novelty censor', 'metal collar', 'arm hug', 'cheek-to-cheek', 'shop', 'leaning', 'shrine', 'spider lily', 'nude cover', 'film grain', 'rei no himo', 'banana', 'mother and son', 'green legwear', 'spread ass', 'skirt suit', 'bikini lift', 'pentagram', 'rooftop', 'strapless bikini', 'framed', 'wizard hat', 'chicken', 'pompadour', ';q', 'macaron', 'purple rose', 'trefoil', 'collared jacket', 'slave', 'hair tucking', 'steepled fingers', 'cake slice', 'butt plug', 'swimsuit aside', 'print dress', 'perky breasts', 'pantylines', 'sushi', 'policewoman', 'lower body', 'cream', 'framed breasts', 'official wallpaper', 'egg vibrator', 'heart choker', 'vertical-striped legwear', 'transformation', 'dancer', 'flower-shaped pupils', 'staring', 'bra removed', 'bandaids on nipples', 'frilled legwear', 'lemon', 'capri pants', 'rudder footwear', 'maid bikini', 'hair strand', 'middle finger', 'pizza', 'open dress', 'baozi', 'hair beads', 'candy apple', 'stirrup legwear', 'stage', 'arm belt', 'pussy juice trail', 'chewing gum', 'squirrel ears', 'bandage over one eye', 'gym shorts', 'hairpods', 'meiji schoolgirl uniform', 'breast slip', 'finger gun', 'parfait', 'kindergarten uniform', 'shore', 'drop shadow', 'heart-shaped eyewear', 'gothic', 'multiple hair bows', 'goggles around neck', 'lineup', 'riding crop', 'leotard aside', 'suit jacket', 'upright straddle', 'hair twirling', 'bat hair ornament', 'reverse bunnysuit', 'plaid dress', 'sailor bikini', 'artbook', 'holding underwear', 'bone hair ornament', "hands on another's face", 'sandwich', 'tomato', 'viewfinder', 'layered bikini', 'alternate legwear', 'pancake', 'feather boa', 'pubic hair peek', 'humanization', 'gas mask', 'bamboo forest', 'grinding', 'soda can', 'surreal', 'goggles on headwear', 'bubble tea', 'letterman jacket', 'scowl', 'arms around neck', 'multi-tied hair', 'shooting star', 'lily pad', 'orange hairband', 'magazine cover', 'kanzashi', 'heart in eye', 'raccoon girl', '5koma', 'green neckwear', 'piano', 'snowflake hair ornament', 'crotch rope', 'yellow rose', 'thinking', 'gloom (expression)', 'open-chest sweater', 'left-to-right manga', 'watson cross', 'vertical-striped dress', 'mochi', 'aisaka taiga', 'bodysuit under clothes', 'ribbed dress', 'sheep ears', 'neck ruff', 'lotus', 'breastless clothes', 'chemise', 'cupcake', 'collage', 'covering eyes', 'diffraction spikes']

sampler = 'DPM++ 2M Karras'
seed = 1
steps = 30
width = 512
height = 512
cfg_scale = 7

存图文件夹 = Path('out')
存图文件夹.mkdir(exist_ok=True)

check_model(要测的模型)


if Path('savedata/记录.json').exists():
    with open('savedata/记录.json', 'r', encoding='utf8') as f:
        记录 = json.load(f)
else:
    记录 = []

for (model, VAE), 标签 in tqdm(itertools.product(要测的模型, 要测的标签), total=len(要测的模型) * len(要测的标签), ncols=60):
    标签 = 标签.strip().replace(' ', '_')
    参数 = {
        'prompt': f'1 girl, {标签}',
        'negative_prompt': 'worst quality, low quality, blurry, greyscale, monochrome',
        'seed': seed,
        'width': width,
        'height': height,
        'steps': steps,
        'sampler_index': sampler,
        'cfg_scale': cfg_scale,
        'override_settings': {
            'sd_model_checkpoint': model,
            'sd_vae': VAE,
        },
    }
    skip = False
    for i in 记录:
        if i['标签'] == 标签 and i['参数'] == 参数:
            skip = True
            break
    if skip:
        continue
    数量参数 = {
        'batch_size': 4,
        'n_iter': 4,
    }
    r = 缓存上网(f'{服务器地址}/sdapi/v1/txt2img', 数量参数 | 参数, 'post')
    图s = [base64.b64decode(b64) for b64 in r['images']]
    for i, b in enumerate(图s):
        with open(存图文件夹 / safe_name(f'{标签}-{i}@{model}×{VAE}@{width}×{height}@{steps}×{sampler}.png'), 'wb') as f:
            f.write(b)
    n = len(图s)
    预测标签 = ml_danbooru标签([存图文件夹 / safe_name(f'{标签}-{i}@{model}×{VAE}@{width}×{height}@{steps}×{sampler}.png') for i in range(n)])
    录 = {
        '分数': [i.get(标签, 0) for i in 预测标签.values()],
        '总数': n,
        '标签': 标签,
        '参数': 参数,
    }
    记录.append(录)
    with open('savedata/记录.json', 'w', encoding='utf8') as f:
        f.write(json.dumps(记录, ensure_ascii=False, indent=4))
